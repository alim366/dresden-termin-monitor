name: Dresden Termin Monitor (Telegram)

on:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes (UTC)
  workflow_dispatch:


concurrency:
  group: dresden-termin-monitor
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TZ: Europe/Berlin
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Heartbeat
        run: echo "HEARTBEAT: $(date -u '+%Y-%m-%d %H:%M:%S') UTC"

      # Only allow heavy steps 06:00–19:00 Berlin time
      - id: window
        name: Guard time window
        run: |
          HOUR=$(TZ=Europe/Berlin date +%H)
          if [ "$HOUR" -ge 6 ] && [ "$HOUR" -lt 19 ]; then
            echo "run=1" >> "$GITHUB_OUTPUT"
            echo "INSIDE_WINDOW $HOUR:00"
          else
            echo "run=0" >> "$GITHUB_OUTPUT"
            echo "OUTSIDE_WINDOW $HOUR:00"
          fi

      - name: Setup Node
        if: steps.window.outputs.run == '1'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create package.json
        if: steps.window.outputs.run == '1'
        run: |
          cat > package.json << 'EOF'
          {
            "name": "dresden-termin-monitor",
            "version": "1.0.0",
            "private": true,
            "type": "module",
            "scripts": { "check": "node check.js" },
            "dependencies": { "playwright": "^1.48.2" }
          }
          EOF

      - name: Install dependencies & browser (with retry)
        if: steps.window.outputs.run == '1'
        run: |
          npm install --no-audit --no-fund || (sleep 10 && npm install --no-audit --no-fund)
          npx playwright install --with-deps chromium || (sleep 15 && npx playwright install --with-deps chromium)

      - name: Write checker script
        if: steps.window.outputs.run == '1'
        run: |
          cat > check.js << 'EOF'
          import { chromium } from "playwright";

          // --- Config ---
          const URL = "https://termine-buergerbuero.dresden.de/select2?md=1";
          const SERVICE_TEXTS = [
            "Antragsabgabe Einbürgerung",
            "Einbürgerung",
            "Staatsangehörigkeit"
          ];
          const WINDOW = { startHour: 6, endHour: 19 }; // 06–19 Berlin

          const NO_PATTERNS = [
            /keine\s+freien\s+Termine/i,
            /Zur\s*Zeit.*keine\s+Termine/i,
            /Aktuell\s+sind\s+keine\s+Termine/i,
            /Es\s+sind\s+keine\s+Termine/i,
            /Derzeit\s+stehen\s+keine\s+Termine/i
          ];

          const uniq = (a) => [...new Set(a)];

          function withinWindow() {
            const fmt = new Intl.DateTimeFormat("de-DE", { timeZone: "Europe/Berlin", hour: "2-digit", hour12: false });
            const h = parseInt(fmt.format(new Date()), 10);
            return h >= WINDOW.startHour && h < WINDOW.endHour;
          }

          async function notifyTelegram(title, message) {
            const token = process.env.TELEGRAM_TOKEN;
            const chatId = process.env.TELEGRAM_CHAT_ID;
            if (!token || !chatId) { console.log("TELEGRAM_SECRETS_MISSING"); return; }
            const text = `*${title}*\n${message}\n[Open booking page](${URL})`;
            const res = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ chat_id: chatId, text, parse_mode: "Markdown" })
            }).catch(()=>null);
            console.log("TELEGRAM_STATUS", res?.status ?? "no-response");
          }

          function extractSlots(text) {
            const dateRegex1 = /(\d{2}\.\d{2}\.\d{4})/;
            const dateRegex2 = /(?:Mo|Di|Mi|Do|Fr|Sa|So)[.,]?\s+(\d{2}\.\d{2}\.\d{4})/i;
            const timeRegex = /\b([01]?\d|2[0-3]):([0-5]\d)\b/g;

            const dateMatch = text.match(dateRegex1) || text.match(dateRegex2);
            const timesRaw = text.match(timeRegex) || [];
            const times = uniq(timesRaw.map(t => t.trim()));

            const locMatch = text.match(/Standort[:\s]*([A-Za-zÄÖÜäöüß\-\s\/]+)</i);
            const location = locMatch ? locMatch[1].trim() : null;

            return { date: dateMatch ? (dateMatch[1] || dateMatch[0]) : null, times, location };
          }

          (async () => {
            try {
              console.log("CHECK_STARTED");

              if (!withinWindow()) { console.log("OUTSIDE_WINDOW_SKIP"); process.exit(0); }

              const browser = await chromium.launch({ headless: true });
              const ctx = await browser.newContext({ locale: "de-DE", timezoneId: "Europe/Berlin" });
              const page = await ctx.newPage();

              await page.goto(URL, { waitUntil: "domcontentloaded", timeout: 60000 });
              console.log("NAVIGATED");

              // Try cookie consent
              for (const label of ["OK", "Akzeptieren", "Einverstanden"]) {
                try {
                  const btn = page.getByRole("button", { name: label }).first();
                  if ((await btn.count()) > 0) { await btn.click(); break; }
                  const txt = page.getByText(label, { exact: true });
                  if ((await txt.count()) > 0) { await txt.click(); break; }
                } catch {}
              }

              // Select service
              try {
                for (const s of SERVICE_TEXTS) {
                  const service = page.getByText(s, { exact: false }).first();
                  if ((await service.count()) > 0) { await service.click({ force: true }); console.log("SERVICE_CLICKED", s); break; }
                  const label = page.locator(`label:has-text("${s}")`);
                  if ((await label.count()) > 0) { await label.click({ force: true }); console.log("SERVICE_LABEL_CLICKED", s); break; }
                }
              } catch {}

              // Click "Weiter"
              try {
                const weiter = page.getByRole("button", { name: /weiter/i }).first();
                if ((await weiter.count()) > 0) {
                  await weiter.click({ force: true }); console.log("WEITER_CLICKED");
                } else {
                  await page.locator("text=Weiter").first().click({ timeout: 5000 }).then(()=>console.log("WEITER_TEXT_CLICKED")).catch(()=>{});
                }
              } catch {}

              await page.waitForTimeout(2500);
              console.log("AFTER_WEITER");

              const bodyText = await page.locator("body").innerText();
              console.log("BODY_LEN", bodyText.length);

              if (NO_PATTERNS.some(rx => rx.test(bodyText))) {
                console.log("NO_SLOTS");
                await browser.close();
                process.exit(0);
              }

              const html = await page.content();
              const { date, times, location } = extractSlots(html + "\n" + bodyText);
              console.log("TIMES_FOUND", times.length);

              if (times.length > 0) {
                const top3 = times.slice(0, 3).join(", ");
                const parts = [];
                if (date) parts.push(`Date: ${date}`);
                parts.push(`Times: ${top3}`);
                if (location) parts.push(`Place: ${location}`);
                const msg = parts.join(" | ");
                await notifyTelegram("Einbürgerung Dresden – Slot available", msg);
                console.log("SLOT_FOUND", msg);
              } else {
                console.log("NO_SLOTS");
              }

              await browser.close();
              process.exit(0);
            } catch (e) {
              console.log("CHECK_FAILED:", e?.message || String(e));
              process.exit(0);
            }
          })();
          EOF

      - name: Run checker (never fail)
        if: steps.window.outputs.run == '1'
        run: |
          set +e
          npm run check
          CODE=$?
          echo "CHECK_EXIT_CODE=$CODE"
          exit 0
